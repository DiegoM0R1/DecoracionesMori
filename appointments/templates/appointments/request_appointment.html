{% extends "base.html" %}
{% load i18n %}      
{% load form_tags %}  <!-- Añade esta línea al inicio de tu template -->

{% block title %}Solicitar Cita - DecoracionesMori{% endblock %}

{% block content %}
<section class="appointment-request py-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-4 mb-3">Solicitar Servicio</h1>
                <p class="lead text-muted">Complete el formulario para solicitar su cita de servicio.</p>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <form method="post" novalidate>
                            {% csrf_token %}
                            {{ form.as_p }}
                            <div class="mb-3">
                                <label class="form-label">Ubicación en Mapa</label>
                                <div id="map_canvas" style="width: 100%; height: 300px; margin-top: 10px; border-radius: 4px;"></div>
                            </div>
                            {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}

                           
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-calendar-check me-2"></i>Solicitar Servicio
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-lock me-1"></i>Tus datos están seguros y serán tratados confidencialmente
                    </small>
                </div>
            </div>
        </div>
    </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script> <script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('id_appointment_date_form'); // Asegúrate que tu input de fecha tenga este ID

    // Obtener datos de disponibilidad (esto es una simplificación, necesitarías un endpoint real)
    fetch("{% url 'appointments:api_daily_availability' %}") // URL a tu endpoint de disponibilidad
        .then(response => response.json())
        .then(availabilityData => {
            flatpickr(dateInput, {
                locale: "es", // Español
                dateFormat: "Y-m-d", // Formato que Django espera
                minDate: new Date().fp_incr(1), // Mínimo mañana
                disable: [
                    function(date) {
                        // Deshabilitar fines de semana (ejemplo, si no usas ScheduledWorkDay para esto)
                        // return (date.getDay() === 0 || date.getDay() === 6);

                        const dateStr = date.toISOString().split('T')[0];
                        const dayStatus = availabilityData[dateStr];

                        if (dayStatus === "full" || dayStatus === "not_working" || dayStatus === "not_scheduled") {
                            return true; // Deshabilitar fecha
                        }
                        return false; // Habilitar fecha
                    }
                ],
                onChange: function(selectedDates, dateStr, instance) {
                    // Cuando una fecha es seleccionada, podrías cargar horas disponibles
                    console.log("Fecha seleccionada:", dateStr);
                    // Aquí llamarías a otra función para cargar/validar horas
                    // loadAvailableTimes(dateStr);
                }
            });
        })
        .catch(error => console.error("Error cargando datos de disponibilidad:", error));

    // Función para cargar horas (concepto)
    // function loadAvailableTimes(dateStr) {
    //     const timeInput = document.getElementById('id_appointment_time_form');
    //     // Fetch a /api/available-times-for-date?date=dateStr
    //     // y luego actualiza el input de hora (ej. min/max o un select)
    // }
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Script de búsqueda de DNI iniciado (v2).');
        const dniInput = document.getElementById('id_dni');
        const nameInput = document.getElementById('id_name'); // Campo visible de Nombre Completo
    
        // Referencias a los NUEVOS campos ocultos (debes añadirlos en el Django Form)
        const nombresHiddenInput = document.getElementById('id_nombres_hidden');
        const paternoHiddenInput = document.getElementById('id_apellido_paterno_hidden');
        const maternoHiddenInput = document.getElementById('id_apellido_materno_hidden');
    
        if (!dniInput || !nameInput || !nombresHiddenInput || !paternoHiddenInput || !maternoHiddenInput) {
            console.error('No se encontraron todos los campos necesarios (DNI, Nombre visible, o campos ocultos de nombre). Verifica los IDs.');
            return;
        }
    
        let debounceTimeout = null;
    
        async function fetchDniData(dniValue) {
            const dni = dniValue.trim();
            if (dni.length !== 8) return;
    
            console.log('Buscando DNI (v2):', dni);
            nameInput.placeholder = 'Buscando...';
            nameInput.disabled = true;
            nameInput.value = ''; // Limpiar campo visible
            // Limpiar campos ocultos
            nombresHiddenInput.value = '';
            paternoHiddenInput.value = '';
            maternoHiddenInput.value = '';
    
    
            const csrftokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrftokenElement) {
                console.error('Token CSRF no encontrado.');
                alert('Error de configuración interna.');
                nameInput.placeholder = 'Tu nombre completo';
                nameInput.disabled = false;
                return;
            }
            const csrftoken = csrftokenElement.value;
    
            try {
                const response = await fetch('{% url "appointments:buscar_dni" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: new URLSearchParams({ 'dni': dni })
                });
    
                const data = await response.json();
                console.log('Datos DNI recibidos (v2):', data);
    
                if (!response.ok) throw new Error(data.error || `Error HTTP ${response.status}`);
                if (data.error) throw new Error(data.error);
    
                let nombresApi = data.nombres || '';
                let paternoApi = data.apellidoPaterno || '';
                let maternoApi = data.apellidoMaterno || '';
    
                // Rellenar los campos ocultos con los datos estructurados de la API
                nombresHiddenInput.value = nombresApi;
                paternoHiddenInput.value = paternoApi;
                maternoHiddenInput.value = maternoApi;
    
                // Construir el nombre completo para el campo VISIBLE (Nombres ApellidoPaterno ApellidoMaterno)
                let nombreCompletoVisible = `${nombresApi} ${paternoApi} ${maternoApi}`.trim().replace(/\s+/g, ' ');
    
                if (nombreCompletoVisible) {
                    const nombreFormateado = nombreCompletoVisible
                        .toLowerCase()
                        .split(' ')
                        .filter(palabra => palabra.length > 0)
                        .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1))
                        .join(' ');
                    nameInput.value = nombreFormateado; // Rellena el campo de nombre visible
                    console.log('Campo visible "Nombre Completo" actualizado:', nombreFormateado);
                    nameInput.classList.add('is-valid');
                    setTimeout(() => nameInput.classList.remove('is-valid'), 2000);
                } else {
                    // Si no hay datos para el nombre visible, intentar con data.nombre_completo (fallback)
                    let fallbackNombre = (data.nombre_completo || "").trim();
                    if (fallbackNombre) {
                         if (fallbackNombre.includes(',')) { // "APELLIDOS, NOMBRES"
                            const partes = fallbackNombre.split(',');
                            if (partes.length === 2) fallbackNombre = `${partes[1].trim()} ${partes[0].trim()}`;
                            else fallbackNombre = fallbackNombre.replace(/,/g, '');
                        }
                        nameInput.value = fallbackNombre.toLowerCase().split(' ').filter(p=>p).map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join(' ');
                        console.log('Campo visible "Nombre Completo" actualizado con fallback:', nameInput.value);
                    } else {
                        alert('No se encontró información de nombre para el DNI.');
                    }
                }
    
            } catch (error) {
                console.error('Error en fetchDniData (v2):', error);
                alert(`Error al buscar DNI: ${error.message}`);
                nameInput.value = ''; // Limpiar en caso de error
                nombresHiddenInput.value = '';
                paternoHiddenInput.value = '';
                maternoHiddenInput.value = '';
            } finally {
                nameInput.placeholder = 'Tu nombre completo (se autocompleta con DNI)';
                nameInput.disabled = false;
            }
        }
    
        dniInput.addEventListener('input', function() {
            clearTimeout(debounceTimeout);
            const dniValue = this.value.trim();
            if (dniValue.length === 8) {
                debounceTimeout = setTimeout(() => fetchDniData(dniValue), 300);
            } else {
                // Opcional: Limpiar campos si el DNI ya no es válido
                // nameInput.value = '';
                // nombresHiddenInput.value = ''; // etc.
            }
        });
    
        dniInput.addEventListener('blur', function() {
            clearTimeout(debounceTimeout);
            const dniValue = this.value.trim();
            if (dniValue.length === 8) fetchDniData(dniValue);
        });
    });
    </script>


<!-- Google Maps integration -->
{{ js_translations|json_script:"js-translations" }}
{% if MAPS_API_KEY %}
<script>
// Define global variables
let map = null; 
let marker = null;
let autocomplete = null;
let geocoder = null;

function initMapAndAutocomplete() {
    console.log("Google Maps API cargada. Inicializando mapa y autocomplete...");
    
    // Get the address input
    const addressInput = document.getElementById('id_address_input');
    const mapCanvas = document.getElementById('map_canvas');
    
    if (!addressInput) {
        console.error("Input de dirección ('id_address_input') no encontrado");
        return;
    }
    
    // Create map container if it doesn't exist
    if (!mapCanvas) {
        console.log("Elemento de mapa ('map_canvas') no encontrado, creando uno nuevo...");
        const mapContainer = document.createElement('div');
        mapContainer.id = 'map_canvas';
        mapContainer.style.width = '100%';
        mapContainer.style.height = '300px';
        mapContainer.style.marginTop = '10px';
        mapContainer.style.borderRadius = '4px';
        
        // Insert after address field
        addressInput.parentNode.insertAdjacentElement('afterend', mapContainer);
    }
    
    try {
        // Initialize geocoder
        geocoder = new google.maps.Geocoder();
        
        // Default coordinates (Chiclayo)
        const initialLatLng = { lat: -6.7714, lng: -79.8409 };
        
        // Initialize map (visible from the start)
        map = new google.maps.Map(document.getElementById('map_canvas'), {
            center: initialLatLng,
            zoom: 15,
            mapTypeControl: true,
            streetViewControl: false
        });
        
        // Initialize marker
        marker = new google.maps.Marker({
            position: initialLatLng,
            map: map,
            draggable: true,
            title: 'Arrastra para ajustar la ubicación'
        });
        
        // Listen for marker drag events
        google.maps.event.addListener(marker, 'dragend', function() {
            const position = marker.getPosition();
            map.setCenter(position);
            
            // Reverse geocode to get address
            geocoder.geocode({ 'location': position }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    addressInput.value = results[0].formatted_address;
                } else {
                    console.warn("Geocodificación inversa falló:", status);
                }
            });
        });
        
        // Listen for map click events
        google.maps.event.addListener(map, 'click', function(event) {
            marker.setPosition(event.latLng);
            
            // Trigger dragend to update address
            google.maps.event.trigger(marker, 'dragend');
        });
        
        // Initialize autocomplete
        const autocompleteOptions = {
            componentRestrictions: { country: "pe" },
            fields: ["formatted_address", "geometry", "name"]
        };
        
        autocomplete = new google.maps.places.Autocomplete(addressInput, autocompleteOptions);
        
        // Prevent form submission when pressing Enter
        addressInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });
        
        // Handle place selection
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            if (!place.geometry || !place.geometry.location) {
                console.warn("Lugar seleccionado no tiene datos de geometría:", place.name);
                return;
            }
            
            // Update map and marker
            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            }
            
            marker.setPosition(place.geometry.location);
        });
        
        console.log("Mapa y autocomplete inicializados correctamente");
    } catch (error) {
        console.error("Error inicializando Google Maps:", error);
    }
}

// Make function global for callback
window.initMapAndAutocomplete = initMapAndAutocomplete;
</script>

<!-- Fix the API key in the script URL and use async loading -->
<script async src="https://maps.googleapis.com/maps/api/js?key={{ MAPS_API_KEY }}&libraries=places&callback=initMapAndAutocomplete&language=es"></script>
{% else %}
<script>console.error("Google Maps API Key (MAPS_API_KEY) no configurada o no recibida por la plantilla.");</script>
{% endif %}
{% endblock %}