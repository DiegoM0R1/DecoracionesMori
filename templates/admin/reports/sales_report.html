{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .report-controls { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .report-controls form { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    #calendar { max-width: 100%; margin: 20px 0; }
  </style>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="report-controls">
  <form method="GET" action="">
    <div class="form-group">
      <label for="start">Desde:</label>
      <input type="text" id="start" name="start" class="form-control" value="{{ start_date }}">
    </div>
    <div class="form-group">
      <label for="end">Hasta:</label>
      <input type="text" id="end" name="end" class="form-control" value="{{ end_date }}">
    </div>
    <input type="hidden" name="range" id="range_input" value="{{ range_preset }}">
    
    <div>
        <button type="submit" class="btn btn-primary" onclick="setRange('custom')">Filtrar</button>
        <button type="submit" class="btn btn-secondary" onclick="setRange('day')">Hoy</button>
        <button type="submit" class="btn btn-secondary" onclick="setRange('week')">Semana</button>
        <button type="submit" class="btn btn-secondary" onclick="setRange('month')">Mes</button>
    </div>
    
    <div style="margin-left: auto;">
        <a href="{% url 'reports:download_csv' %}?{{ request.GET.urlencode }}" class="btn btn-success">
            <i class="fas fa-file-csv"></i> Descargar CSV
        </a>
        <a href="{% url 'reports:download_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger">
            <i class="fas fa-file-pdf"></i> Descargar PDF
        </a>
    </div>
  </form>
</div>

<h2>Previsualizaci√≥n de Ventas</h2>
<div id="calendar"></div>

<h2>Datos del Reporte ({{ start_date }} al {{ end_date }})</h2>
<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead class="thead-dark">
      <tr>
        <th>Servicio</th>
        <th>Cantidad Vendida</th>
        <th>Ingresos Totales (Subtotal)</th>
      </tr>
    </thead>
    <tbody>
      {% for item in report_data %}
      <tr>
        <td>{{ item.service__name }}</td>
        <td>{{ item.total_sold }}</td>
        <td>S/ {{ item.total_revenue|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3">No se encontraron ventas para este rango de fechas.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extrajs %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar Datepickers
      flatpickr("#start", { dateFormat: "Y-m-d" });
      flatpickr("#end", { dateFormat: "Y-m-d" });

      // Inicializar FullCalendar
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: {{ calendar_events|safe }}
      });
      calendar.render();
    });

    // JS para los botones de preset
    function setRange(range) {
      document.getElementById('range_input').value = range;
      if (range !== 'custom') {
        // Limpiamos los inputs custom para no confundir
        document.getElementById('start').value = '';
        document.getElementById('end').value = '';
      }
    }
  </script>
{% endblock %}