{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
  <style>
    .inventory-dashboard {
        margin-top: 20px;
    }
    
    .stats-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .stat-box {
        flex: 1;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .stat-box h3 {
        margin-top: 0;
        font-size: 16px;
    }
    
    .stat-box .number {
        font-size: 24px;
        font-weight: bold;
    }
    
    .good { background-color: #e8f5e9; }
    .warning { background-color: #fff8e1; }
    .danger { background-color: #ffebee; }
    
    .filters-container {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .inventory-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .inventory-table th, .inventory-table td {
        padding: 8px;
        border: 1px solid #ddd;
    }
    
    .inventory-table th {
        background-color: #f5f5f5;
    }
    
    .inventory-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .low-stock {
        color: orange;
        font-weight: bold;
    }
    
    .out-of-stock {
        color: red;
        font-weight: bold;
    }
    
    .module h2 {
        background: #79aec8;
        color: #fff;
        padding: 8px;
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
  &rsaquo; <a href="{% url 'admin:app_list' app_label='inventory' %}">{% trans 'Inventario' %}</a>
  &rsaquo; {% trans 'Reporte de Inventario' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>Reporte de Inventario</h1>
    
    <div class="inventory-dashboard">
        <!-- Estadísticas -->
        <div class="stats-container">
            <div class="stat-box good">
                <h3>{% trans "Total de Productos" %}</h3>
                <div class="number">{{ stats.total_products }}</div>
            </div>
            
            <div class="stat-box warning">
                <h3>{% trans "Bajo Stock" %}</h3>
                <div class="number">{{ stats.low_stock }}</div>
            </div>
            
            <div class="stat-box danger">
                <h3>{% trans "Sin Stock" %}</h3>
                <div class="number">{{ stats.out_of_stock }}</div>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="module">
            <h2>{% trans "Filtrar Inventario" %}</h2>
            <div class="filters-container">
                <form method="get">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div>
                            <label for="category">{% trans "Categoría:" %}</label>
                            <select name="category" id="category">
                                <option value="">{% trans "Todas las categorías" %}</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label for="status">{% trans "Estado:" %}</label>
                            <select name="status" id="status">
                                <option value="">{% trans "Todos los estados" %}</option>
                                <option value="low" {% if selected_status == "low" %}selected{% endif %}>
                                    {% trans "Bajo mínimo" %}
                                </option>
                                <option value="out" {% if selected_status == "out" %}selected{% endif %}>
                                    {% trans "Sin stock" %}
                                </option>
                            </select>
                        </div>
                        
                        <div>
                            <button type="submit" class="button">{% trans "Filtrar" %}</button>
                            <a href="{% url 'admin:inventory_report' %}" class="button">{% trans "Limpiar" %}</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Estado Actual de Inventario -->
        <div class="module">
            <h2>{% trans "Estado Actual de Inventario" %}</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>{% trans "Producto" %}</th>
                        <th>{% trans "Categoría" %}</th>
                        <th>{% trans "Stock Actual" %}</th>
                        <th>{% trans "Stock Mínimo" %}</th>
                        <th>{% trans "Estado" %}</th>
                        <th>{% trans "Acciones" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inventory_items %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td>{{ item.product.category.name|default:"-" }}</td>
                        <td>
                            {{ item.current_stock }} {{ item.product.unit }}
                            {% if item.current_stock <= 0 %}
                            <span class="out-of-stock">{% trans "(Sin stock)" %}</span>
                            {% elif item.current_stock < item.product.stock_min %}
                            <span class="low-stock">{% trans "(Bajo mínimo)" %}</span>
                            {% endif %}
                        </td>
                        <td>{{ item.product.stock_min }} {{ item.product.unit }}</td>
                        <td>
                            {% if item.current_stock <= 0 %}
                            <span class="out-of-stock">{% trans "Sin stock" %}</span>
                            {% elif item.current_stock < item.product.stock_min %}
                            <span class="low-stock">{% trans "Bajo mínimo" %}</span>
                            {% else %}
                            <span style="color: green;">{% trans "Normal" %}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'admin:inventory_product_history' item.product.id %}" class="button">
                                {% trans "Ver historial" %}
                            </a>
                            <a href="{% url 'admin:inventory_inventorymovement_add' %}?product={{ item.product.id }}&movement_type=entrada" class="button">
                                {% trans "Registrar entrada" %}
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6">{% trans "No hay productos en el inventario." %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Resumen por Categoría -->
        <div class="module">
            <h2>{% trans "Resumen por Categoría" %}</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>{% trans "Categoría" %}</th>
                        <th>{% trans "Cantidad de Productos" %}</th>
                        <th>{% trans "Productos bajo mínimo" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for summary in category_summary %}
                    <tr>
                        <td>{{ summary.category.name }}</td>
                        <td>{{ summary.product_count }}</td>
                        <td>
                            {{ summary.low_stock }}
                            {% if summary.low_stock > 0 %}
                            <span class="low-stock">({{ summary.low_stock|floatformat:"0" }}%)</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">{% trans "No hay categorías con productos." %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Movimientos recientes -->
        <div class="module">
            <h2>{% trans "Movimientos Recientes" %}</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>{% trans "Fecha" %}</th>
                        <th>{% trans "Producto" %}</th>
                        <th>{% trans "Tipo" %}</th>
                        <th>{% trans "Cantidad" %}</th>
                        <th>{% trans "Referencia" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for movement in recent_movements %}
                    <tr>
                        <td>{{ movement.created_at|date:"d/m/Y H:i" }}</td>
                        <td>{{ movement.product.name }}</td>
                        <td>
                            {% if movement.movement_type == 'entrada' %}
                            <span style="color: green;">{% trans "Entrada" %}</span>
                            {% else %}
                            <span style="color: red;">{% trans "Salida" %}</span>
                            {% endif %}
                        </td>
                        <td>{{ movement.quantity }} {{ movement.product.unit }}</td>
                        <td>{{ movement.document_reference|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5">{% trans "No hay movimientos recientes." %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}