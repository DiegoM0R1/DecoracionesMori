{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
  <style>
    .product-info {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .product-details {
        flex: 2;
        padding: 15px;
        background-color: #f8f8f8;
        border-radius: 5px;
    }
    
    .product-status {
        flex: 1;
        text-align: center;
        padding: 15px;
        border-radius: 5px;
        background-color: #e8f5e9;
    }
    
    .product-status.warning {
        background-color: #fff8e1;
    }
    
    .product-status.danger {
        background-color: #ffebee;
    }
    
    .product-status .stock {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .history-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .history-table th, .history-table td {
        padding: 8px;
        border: 1px solid #ddd;
    }
    
    .history-table th {
        background-color: #f5f5f5;
    }
    
    .history-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .entrada {
        color: green;
    }
    
    .salida {
        color: red;
    }
    
    .balance {
        font-weight: bold;
    }
    
    .module h2 {
        background: #79aec8;
        color: #fff;
        padding: 8px;
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
  &rsaquo; <a href="{% url 'admin:app_list' app_label='inventory' %}">{% trans 'Inventario' %}</a>
&rsaquo; <a href="{% url 'admin:inventory_inventorystatus_view_report' %}">{% trans 'Reporte de Inventario' %}</a>
  &rsaquo; {% trans 'Historial de Producto' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>Historial de Producto: {{ product.name }}</h1>
    
    <div class="product-info">
        <div class="product-details">
            <h2>{{ product.name }}</h2>
            <p><strong>{% trans "Categoría:" %}</strong> {{ product.category.name|default:"-" }}</p>
            <p><strong>{% trans "Descripción:" %}</strong> {{ product.description }}</p>
            <p><strong>{% trans "Precio:" %}</strong> {{ product.price_per_unit }} por {{ product.unit }}</p>
        </div>
        
        <div class="product-status {% if current_balance <= 0 %}danger{% elif current_balance < product.stock_min %}warning{% endif %}">
            <h3>{% trans "Stock Actual" %}</h3>
            <div class="stock">{{ current_balance }} {{ product.unit }}</div>
            <p>{% trans "Mínimo requerido:" %} {{ product.stock_min }} {{ product.unit }}</p>
            
            {% if current_balance <= 0 %}
            <p><strong style="color: red;">{% trans "SIN STOCK" %}</strong></p>
            {% elif current_balance < product.stock_min %}
            <p><strong style="color: orange;">{% trans "BAJO MÍNIMO" %}</strong></p>
            {% else %}
            <p><strong style="color: green;">{% trans "STOCK NORMAL" %}</strong></p>
            {% endif %}
        </div>
    </div>
    
    <!-- Acciones rápidas -->
    <div class="submit-row">
        <a href="{% url 'admin:inventory_inventorymovement_add' %}?product={{ product.id }}&movement_type=entrada" class="button default">
            {% trans "Registrar entrada" %}
        </a>
        <a href="{% url 'admin:inventory_inventorymovement_add' %}?product={{ product.id }}&movement_type=salida" class="button">
            {% trans "Registrar salida" %}
        </a>
        <a href="{% url 'admin:services_product_change' product.id %}" class="button">
            {% trans "Editar producto" %}
        </a>
        <a href="{% url 'admin:inventory_inventorystatus_view_report' %}" class="button">
    {% trans "Volver al reporte" %}
</a>
    </div>

    <!-- Historial de movimientos -->
    <div class="module">
        <h2>{% trans "Historial de Movimientos" %}</h2>
        
        {% if movement_history %}
        <table class="history-table">
            <thead>
                <tr>
                    <th>{% trans "Fecha" %}</th>
                    <th>{% trans "Tipo" %}</th>
                    <th>{% trans "Cantidad" %}</th>
                    <th>{% trans "Documento" %}</th>
                    <th>{% trans "Notas" %}</th>
                    <th>{% trans "Saldo" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in movement_history %}
                <tr>
                    <td>{{ entry.movement.created_at|date:"d/m/Y H:i" }}</td>
                    <td class="{{ entry.movement.movement_type }}">
                        {% if entry.movement.movement_type == 'entrada' %}
                        {% trans "ENTRADA" %}
                        {% else %}
                        {% trans "SALIDA" %}
                        {% endif %}
                    </td>
                    <td>{{ entry.movement.quantity }} {{ product.unit }}</td>
                    <td>{{ entry.movement.document_reference|default:"-" }}</td>
                    <td>{{ entry.movement.notes|default:"-" }}</td>
                    <td class="balance">{{ entry.balance }} {{ product.unit }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>{% trans "Este producto no tiene movimientos registrados." %}</p>
        {% endif %}
    </div>
</div>
{% endblock %}